#include "../include/log.h"

#define __STATIC__ extern
//#define __INLINE__ inline

#include <stdio.h>

#include "../include/shift_roll_64.h"

/* **** */

#include <assert.h>
#include <stdint.h>
#include <stdio.h>

/* **** */

#define LOG_ASSERT(_expect, _test, _action) \
	({ \
		typeof(_action) _result = _action; \
		unsigned fail = !(_expect _test _result); \
		const char* pass_fail[2] = { "PASS", "FAIL" }; \
		\
		LOG_START("[ %s ] -- ", pass_fail[fail]); \
		LOG_END(#_expect " " #_test " (0x%016" PRIx64 " <-- " #_action ")", _result); \
		\
		if(fail) { \
			assert(_expect _test _result); \
		} \
	})

/* **** */

static void _test_asr64(void) {
	LOG("asr");
	LOG_ASSERT(0x0000000000000001, ==, asr64(0x0000000000000001, 0));
	LOG_ASSERT(0x0000000000000000, ==, asr64(0x0000000000000001, 1));
	LOG_ASSERT(0x2000000000000000, ==, asr64(0x4000000000000000, 1));
	LOG_ASSERT(0x0800000000000000, ==, asr64(0x4000000000000000, 3));
	LOG_ASSERT(0x0000000000000001, ==, asr64(0x4000000000000000, 62));
	LOG_ASSERT(0xc000000000000000, ==, asr64(0x8000000000000000, 1));
	LOG_ASSERT(0xffffffff00000000, ==, asr64(0x8000000000000000, 31));
	LOG_ASSERT(0xfffffffffffffffe, ==, asr64(0x8000000000000000, 62));
	LOG_ASSERT(0xffffffffffffffff, ==, asr64(0x8000000000000000, 63));
	LOG_ASSERT(0xffffffffffffffff, ==, asr64(0x8000000000000000, 64));
}

static void _test_asr64_vc(void) {
	unsigned out_c = 0;

	LOG("asr_c");
	LOG_ASSERT(0x0000000000000001, ==, asr64_vc(0x0000000000000001, 0, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0xffffffffffffffff, ==, asr64_vc(0xffffffffffffffff, 0, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x0000000000000000, ==, asr64_vc(0x0000000000000001, 1, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);
	LOG_ASSERT(0x0000000000000001, ==, asr64_vc(0x4000000000000000, 62, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x0000000000000000, ==, asr64_vc(0x4000000000000000, 63, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);
	LOG_ASSERT(0x0000000000000000, ==, asr64_vc(0x4000000000000000, 64, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0xffffffffffffffff, ==, asr64_vc(0x8000000000000000, 63, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0xffffffffffffffff, ==, asr64_vc(0x8000000000000000, 64, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);

	LOG_ASSERT(0x1010101010101010, ==, asr64_vc(0x1010101010101010, 0, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x0808080808080808, ==, asr64_vc(0x1010101010101010, 1, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x0404040404040404, ==, asr64_vc(0x1010101010101010, 2, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x1808080808080808, ==, asr64_vc(0x3010101010101010, 1, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0xc808080808080808, ==, asr64_vc(0x9010101010101010, 1, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
}

static void _test_lsl(void) {
	LOG("lsl");
	LOG_ASSERT(0x0000000000000001, ==, lsl64(0x0000000000000001, 0));
	LOG_ASSERT(0x0000000000000002, ==, lsl64(0x0000000000000001, 1));
	LOG_ASSERT(0x0000000000010000, ==, lsl64(0x0000000000000001, 16));
	LOG_ASSERT(0x0000000040000000, ==, lsl64(0x0000000000000001, 30));
	LOG_ASSERT(0x0000000080000000, ==, lsl64(0x0000000000000001, 31));
	LOG_ASSERT(0x0000000100000000, ==, lsl64(0x0000000000000001, 32));
	LOG_ASSERT(0x4000000000000000, ==, lsl64(0x0000000000000001, 62));
	LOG_ASSERT(0x8000000000000000, ==, lsl64(0x0000000000000001, 63));
	LOG_ASSERT(0x0000000000000000, ==, lsl64(0x0000000000000001, 64));

	LOG_ASSERT(0x8000000080000001, ==, lsl64(0x8000000080000001, 0));
	LOG_ASSERT(0x0000000100000002, ==, lsl64(0x0000000080000001, 1));
	LOG_ASSERT(0x0000008000000100, ==, lsl64(0x0000000080000001, 8));
	LOG_ASSERT(0x0000800000010000, ==, lsl64(0x0000000080000001, 16));
	LOG_ASSERT(0x2000000040000000, ==, lsl64(0x0000000080000001, 30));
	LOG_ASSERT(0x4000000080000000, ==, lsl64(0x0000000080000001, 31));
	LOG_ASSERT(0x8000000100000000, ==, lsl64(0x0000000080000001, 32));

	LOG_ASSERT(0x8000000000000001, ==, lsl64(0x8000000000000001, 0));
	LOG_ASSERT(0x0000000000000002, ==, lsl64(0x8000000000000001, 1));
	LOG_ASSERT(0x0000000000000100, ==, lsl64(0x8000000000000001, 8));
	LOG_ASSERT(0x0000000000010000, ==, lsl64(0x8000000000000001, 16));
	LOG_ASSERT(0x0000000040000000, ==, lsl64(0x8000000000000001, 30));
	LOG_ASSERT(0x0000000080000000, ==, lsl64(0x8000000000000001, 31));
	LOG_ASSERT(0x0000000100000000, ==, lsl64(0x8000000000000001, 32));

	LOG_ASSERT(0x8001800100000000, ==, lsl64(0x8001800100000000, 0));
	LOG_ASSERT(0x0003000200000000, ==, lsl64(0x8001800100000000, 1));
	LOG_ASSERT(0x0180010000000000, ==, lsl64(0x8001800100000000, 8));
	LOG_ASSERT(0x8001000000000000, ==, lsl64(0x8001800100000000, 16));
	LOG_ASSERT(0x4000000000000000, ==, lsl64(0x8001800100000000, 30));
	LOG_ASSERT(0x8000000000000000, ==, lsl64(0x8001800100000000, 31));
	LOG_ASSERT(0x0000000000000000, ==, lsl64(0x8001800100000000, 32));
}

static void	_test_lsl_vc(void) {
	unsigned out_c = 0;

	LOG("lsl_c");
	LOG_ASSERT(0x8000000000000001, ==, lsl64_vc(0x8000000000000001, 0, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x0000000000000002, ==, lsl64_vc(0x8000000000000001, 1, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);
	LOG_ASSERT(0xc000000080000000, ==, lsl64_vc(0x8000000180000001, 31, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x8000000100000000, ==, lsl64_vc(0x8000000180000001, 32, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);
	LOG_ASSERT(0x0000000200000000, ==, lsl64_vc(0x8000000080000001, 33, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);

	LOG_ASSERT(0x8080808080808080, ==, lsl64_vc(0x8080808080808080, 0, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x0101010101010100, ==, lsl64_vc(0x8080808080808080, 1, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);
	LOG_ASSERT(0x0202020202020200, ==, lsl64_vc(0x8080808080808080, 2, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
}

static void _test_lsr64(void) {
	LOG("lsr");
	LOG_ASSERT(0x0000000000000001, ==, lsr64(0x0000000000000001, 0));
	LOG_ASSERT(0x0000000000000001, ==, lsr64(0x0000000000000002, 1));
	LOG_ASSERT(0x0000100000000000, ==, lsr64(0x1000000000000000, 16));
	LOG_ASSERT(0x0000000000000001, ==, lsr64(0x4000000000000000, 62));
	LOG_ASSERT(0x0000000000000001, ==, lsr64(0x8000000000000000, 63));
	LOG_ASSERT(0x0000000000000000, ==, lsr64(0x8000000000000000, 64));

	LOG_ASSERT(0x8000000000000001, ==, lsr64(0x8000000000000001, 0));
	LOG_ASSERT(0x4000000000000000, ==, lsr64(0x8000000000000001, 1));
	LOG_ASSERT(0x0080000000000000, ==, lsr64(0x8000000000000001, 8));
	LOG_ASSERT(0x0000800000000000, ==, lsr64(0x8000000000000001, 16));
	LOG_ASSERT(0x0000000200000000, ==, lsr64(0x8000000000000001, 30));
	LOG_ASSERT(0x0000000080000000, ==, lsr64(0x8000000000000001, 32));

	LOG_ASSERT(0x8001800100000000, ==, lsr64(0x8001800100000000, 0));
	LOG_ASSERT(0x4000c00080000000, ==, lsr64(0x8001800100000000, 1));
	LOG_ASSERT(0x0080018001000000, ==, lsr64(0x8001800100000000, 8));
	LOG_ASSERT(0x0000800180010000, ==, lsr64(0x8001800100000000, 16));
	LOG_ASSERT(0x0000000200060004, ==, lsr64(0x8001800100000000, 30));
	LOG_ASSERT(0x0000000100030002, ==, lsr64(0x8001800100000000, 31));
	LOG_ASSERT(0x0000000080018001, ==, lsr64(0x8001800100000000, 32));
}

static void	_test_lsr64_vc(void) {
	unsigned out_c = 0;

	LOG("lsr_c");
	LOG_ASSERT(0x8000000000000001, ==, lsr64_vc(0x8000000000000001, 0, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x4000000000000000, ==, lsr64_vc(0x8000000000000001, 1, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);
	LOG_ASSERT(0x0000000100000001, ==, lsr64_vc(0x8000000080000001, 31, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x0000000080000000, ==, lsr64_vc(0x8000000080000001, 32, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);
	LOG_ASSERT(0x0000000040000000, ==, lsr64_vc(0x8000000080000001, 33, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);

	LOG_ASSERT(0x0080808080808080, ==, lsr64_vc(0x0101010101010101, 1, &out_c));
	LOG_ASSERT(0x0000000000000001, ==, out_c);
	LOG_ASSERT(0x0040404040404040, ==, lsr64_vc(0x0101010101010101, 2, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
	LOG_ASSERT(0x0020202020202020, ==, lsr64_vc(0x0101010101010101, 3, &out_c));
	LOG_ASSERT(0x0000000000000000, ==, out_c);
}

static void _test_rol64(void) {
	LOG("rol");
	LOG_ASSERT(0x8000000000000001, ==, rol64(0x8000000000000001, 0));
	LOG_ASSERT(0x0000000000000003, ==, rol64(0x8000000000000001, 1));
	LOG_ASSERT(0x0000000000000006, ==, rol64(0x8000000000000001, 2));
	LOG_ASSERT(0x000000000000000c, ==, rol64(0x8000000000000001, 3));
	LOG_ASSERT(0x0000000000000180, ==, rol64(0x8000000000000001, 8));
	LOG_ASSERT(0x0000000000018000, ==, rol64(0x8000000000000001, 16));
	LOG_ASSERT(0x0000000018000000, ==, rol64(0x8000000000000001, 28));
	LOG_ASSERT(0x0000000060000000, ==, rol64(0x8000000000000001, 30));
	LOG_ASSERT(0x00000000c0000000, ==, rol64(0x8000000000000001, 31));
	LOG_ASSERT(0x0000000180000000, ==, rol64(0x8000000000000001, 32));
}

static void _test_ror64(void) {
	LOG("ror");
	LOG_ASSERT(0x8000000000000001, ==, ror64(0x8000000000000001, 0));
	LOG_ASSERT(0xc000000000000000, ==, ror64(0x8000000000000001, 1));
	LOG_ASSERT(0x6000000000000000, ==, ror64(0x8000000000000001, 2));
	LOG_ASSERT(0x3000000000000000, ==, ror64(0x8000000000000001, 3));
	LOG_ASSERT(0x0180000000000000, ==, ror64(0x8000000000000001, 8));
	LOG_ASSERT(0x0001800000000000, ==, ror64(0x8000000000000001, 16));
	LOG_ASSERT(0x0000001800000000, ==, ror64(0x8000000000000001, 28));
	LOG_ASSERT(0x0000000c00000000, ==, ror64(0x8000000000000001, 29));
	LOG_ASSERT(0x0000000600000000, ==, ror64(0x8000000000000001, 30));
	LOG_ASSERT(0x0000000300000000, ==, ror64(0x8000000000000001, 31));
	LOG_ASSERT(0x0000000180000000, ==, ror64(0x8000000000000001, 32));
}

static uint64_t bstring(uint64_t data, char* p) {
	const unsigned bits = __SHIFT_BITS__(data);
	char* dst = p;

	for(unsigned i = 1; i <= bits; i++) {
		const unsigned bit = (bits - i);
		*dst++ = ((data >> bit) & 1) ? '1' : '0';
	}

	*dst = 0;

	return(data);
}

#if 0
static void _test_ror64_c(void) {
	char bso[33];
	unsigned cout = 0;

	for(unsigned i = 0; i <= sizeof(uint64_t) << 3; i++) {
//		unsigned cin = (cout = 0 & i & 1);
		unsigned cin = i & 1;
//		LOG("%01u -- 0x%08x -- %s -- %01u", cin, bstring(ror64_c(-2, i, cin, &cout), bso), bso, cout);
//		LOG("%01u -- 0x%08x -- %s -- %01u", 1, bstring(ror64_c(0, i, 1, &cout), bso), bso, cout);
		LOG("%01u -- 0x%08x -- %s -- %01u", cin, bstring(ror64_vc(-2, i, cin, &cout), bso), bso, cout);
		LOG("%01u -- 0x%08x -- %s -- %01u", 1, bstring(ror64_vc(0, i, 1, &cout), bso), bso, cout);
	}
}
#endif

int main(void) {
	if(1) {
		_test_asr64();
		_test_asr64_vc();
		_test_lsl();
		_test_lsl_vc();
		_test_lsr64();
		_test_lsr64_vc();
		_test_rol64();
		_test_ror64();
	}

//	_test_ror64_c();
}
